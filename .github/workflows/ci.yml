name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  analyze_test:
    name: CI (${{ matrix.target }})
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runs_on: [self-hosted, Windows]
            target: windows
          - runs_on: [self-hosted, Windows]
            target: android
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (hosted)
        if: ${{ matrix.use_manual_flutter == false }}
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Flutter (self-hosted Windows manual)
        if: ${{ matrix.use_manual_flutter == true }}
        shell: powershell
        run: |
          $jsonUrl = 'https://storage.googleapis.com/flutter_infra_release/releases/releases_windows.json'
          $releases = Invoke-RestMethod -Uri $jsonUrl
          $baseUrl = $releases.base_url
          $stableHash = $releases.current_release.stable
          $release = $releases.releases | Where-Object { $_.hash -eq $stableHash }
          if (-not $release) { throw "Failed to resolve Flutter stable release info" }
          $archivePath = $release.archive
          $url = "$baseUrl/$archivePath"
          Write-Host "Downloading Flutter SDK: $url"
          $tempRoot = if ($env:RUNNER_TEMP) { $env:RUNNER_TEMP } elseif ($env:TEMP) { $env:TEMP } else { Join-Path $PWD 'temp' }
          if (-not (Test-Path $tempRoot)) { New-Item -ItemType Directory -Path $tempRoot | Out-Null }
          $zipPath = Join-Path $tempRoot 'flutter-sdk.zip'
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          $dest = $tempRoot
          Expand-Archive -Path $zipPath -DestinationPath $dest -Force
          $flutterBin = Join-Path $dest 'flutter/bin'
          if (-not (Test-Path $flutterBin)) { throw "Flutter bin not found at $flutterBin" }
          if ($env:GITHUB_PATH) { Add-Content -Path $env:GITHUB_PATH -Value $flutterBin } else { $env:Path = "$flutterBin;$env:Path" }
          flutter --version

      - name: Cache Pub (hosted only)
        if: runner.os != 'Windows'
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: pub-cache-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('pubspec.yaml') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      - name: Format check
        run: flutter format --set-exit-if-changed .

      - name: Analyze
        run: flutter analyze --no-fatal-infos --no-fatal-warnings

      - name: Tests
        run: flutter test --concurrency=1

      - name: Summary
        if: always()
        run: echo "Analysis & tests completed for ${{ matrix.target }}."
