name: Release
on:
  push:
    tags:
      - 'v*.*.*'
permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: windows
          - os: ubuntu-latest
            target: android
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Cache Pub
        uses: actions/cache@v4
        with:
          path: ${{ matrix.os == 'windows-latest' && 'C:/Users/runneradmin/AppData/Local/Pub/Cache' || '~/.pub-cache' }}
          key: pub-cache-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('pubspec.yaml') }}

      - name: flutter pub get
        run: flutter pub get

      - name: Windows - enable desktop (Windows only)
        if: ${{ matrix.target == 'windows' }}
        run: flutter config --enable-windows-desktop

      - name: Build for Windows
        if: ${{ matrix.target == 'windows' }}
        run: flutter build windows --release

      - name: Create Windows ZIP
        if: ${{ matrix.target == 'windows' }}
        shell: pwsh
        run: |
          $out = 'build/windows/ArknightsTimer-windows.zip'
          $srcDir = 'build/windows/x64/runner/Release'
          if (Test-Path $srcDir) {
            # Compress-Archive automatically includes files in subfolders when given wildcard
            Compress-Archive -Path (Join-Path $srcDir '*') -DestinationPath $out -Force
            Write-Host "Created $out"
          } else {
            Write-Host "Windows build output not found: $srcDir"
          }

      - name: Setup Java 17 (Android only)
        if: ${{ matrix.target == 'android' }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK (Android only)
        if: ${{ matrix.target == 'android' }}
        uses: android-actions/setup-android@v3

      - name: Accept Android licenses (tolerant)
        if: ${{ matrix.target == 'android' }}
        run: |
          set -e
          # attempt to accept licenses but do not fail the job if this step has issues
          yes | sdkmanager --licenses || true

      - name: Build Android APK
        if: ${{ matrix.target == 'android' }}
        run: flutter build apk --release

      - name: Normalize APK filename
        if: ${{ matrix.target == 'android' }}
        shell: bash
        run: |
          # prefer known path, fallback if already at root
          set -e
          shopt -s globstar || true
          CANDIDATES=(build/app/outputs/apk/release/app-release.apk app-release.apk)
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then
              cp "$p" app-release.apk || true
              echo "Found APK: $p"
              break
            fi
          done
          if [ ! -f app-release.apk ]; then
            echo "No APK produced"
          fi

      - name: Upload build artifact (Windows ZIP)
        if: ${{ matrix.target == 'windows' }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: build/windows/ArknightsTimer-windows.zip

      - name: Upload build artifact (Android APK)
        if: ${{ matrix.target == 'android' }}
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-release.apk

  release:
    name: Create Release and Attach Assets
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Gather existing assets
        id: gather
        run: |
          set -e
          shopt -s globstar || true
          files=$(find artifacts -type f \( -name '*.zip' -o -name 'app-release.apk' -o -name 'app-release-*.apk' \) -print || true)
          if [ -z "$files" ]; then
            echo "No assets found"
            # write empty output
            echo "files=" >> $GITHUB_OUTPUT
          else
            # write newline-separated list to output
            echo "files<<EOF" >> $GITHUB_OUTPUT
            printf '%s\n' $files >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release and upload assets
        if: ${{ steps.gather.outputs.files != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: ${{ steps.gather.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
