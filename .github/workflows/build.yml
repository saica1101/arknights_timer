name: Release
on:
  push:
    tags:
      - 'v*.*.*'
permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runs_on: [self-hosted, Windows]
            target: windows
          - runs_on: [self-hosted, Windows]
            target: android
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (Windows manual)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $jsonUrl = 'https://storage.googleapis.com/flutter_infra_release/releases/releases_windows.json'
          $releases = Invoke-RestMethod -Uri $jsonUrl -UseBasicParsing
          $baseUrl = $releases.base_url
          $stableHash = $releases.current_release.stable
          $release = $releases.releases | Where-Object { $_.hash -eq $stableHash }
          if (-not $release) { throw "Failed to resolve Flutter stable release info" }
          $archivePath = $release.archive
          $url = "$baseUrl/$archivePath"
          Write-Host "Downloading Flutter SDK: $url"
          $zipPath = Join-Path $env:RUNNER_TEMP 'flutter-sdk.zip'
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          $dest = $env:RUNNER_TEMP
          Expand-Archive -Path $zipPath -DestinationPath $dest -Force
          $flutterBin = Join-Path $dest 'flutter/bin'
          if (-not (Test-Path $flutterBin)) { throw "Flutter bin not found at $flutterBin" }
          # Add flutter/bin to PATH for subsequent steps
          Add-Content -Path $env:GITHUB_PATH -Value $flutterBin
          flutter --version

      - name: Setup Flutter (non-Windows)
        if: runner.os != 'Windows'
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      # Windows self-hosted runner: skip Pub cache for stability
      # (Ubuntu/Android side keeps cache below)

      - name: Cache Pub (non-Windows)
        if: runner.os != 'Windows'
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: pub-cache-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('pubspec.yaml') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-

      - name: flutter pub get
        run: flutter pub get

      - name: Windows - enable desktop (Windows only)
        if: ${{ matrix.target == 'windows' }}
        run: flutter config --enable-windows-desktop

      - name: Build for Windows
        if: ${{ matrix.target == 'windows' }}
        run: flutter build windows --release

      - name: Create Windows ZIP
        if: ${{ matrix.target == 'windows' }}
        shell: pwsh
        run: |
          $out = 'build/windows/ArknightsTimer-windows.zip'
          $srcDir = 'build/windows/x64/runner/Release'
          if (Test-Path $srcDir) {
            # Compress-Archive automatically includes files in subfolders when given wildcard
            Compress-Archive -Path (Join-Path $srcDir '*') -DestinationPath $out -Force
            Write-Host "Created $out"
          } else {
            Write-Host "Windows build output not found: $srcDir"
          }

      - name: Setup Java 17 (Android only, non-Windows)
        if: ${{ matrix.target == 'android' && runner.os != 'Windows' }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK (Android only, non-Windows)
        if: ${{ matrix.target == 'android' && runner.os != 'Windows' }}
        uses: android-actions/setup-android@v3

      - name: Accept Android licenses (tolerant, non-Windows)
        if: ${{ matrix.target == 'android' && runner.os != 'Windows' }}
        run: |
          set -e
          # attempt to accept licenses but do not fail the job if this step has issues
          yes | sdkmanager --licenses || true

      - name: Build Android APK
        if: ${{ matrix.target == 'android' }}
        run: flutter build apk --release

      - name: Normalize APK filename (Windows PowerShell)
        if: ${{ matrix.target == 'android' && runner.os == 'Windows' }}
        shell: pwsh
        run: |
          $candidates = @(
            'build/app/outputs/flutter-apk/app-release.apk',
            'build/app/outputs/apk/release/app-release.apk',
            'app-release.apk'
          )
          $found = $false
          foreach ($p in $candidates) {
            if (Test-Path $p) {
              Copy-Item $p 'app-release.apk' -Force
              Write-Host "Found APK: $p"
              $found = $true
              break
            }
          }
          if (-not $found) {
            Write-Host 'No APK produced'
          }

      - name: Normalize APK filename (non-Windows)
        if: ${{ matrix.target == 'android' && runner.os != 'Windows' }}
        shell: bash
        run: |
          set -e
          shopt -s globstar || true
          CANDIDATES=(build/app/outputs/flutter-apk/app-release.apk build/app/outputs/apk/release/app-release.apk app-release.apk)
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then
              cp "$p" app-release.apk || true
              echo "Found APK: $p"
              break
            fi
          done
          if [ ! -f app-release.apk ]; then
            echo "No APK produced"
          fi

      - name: Upload build artifact (Windows ZIP)
        if: ${{ matrix.target == 'windows' }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: build/windows/ArknightsTimer-windows.zip

      - name: Upload build artifact (Android APK)
        if: ${{ matrix.target == 'android' }}
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-release.apk

  release:
    name: Create Release and Attach Assets
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Gather existing assets
        id: gather
        run: |
          set -e
          shopt -s globstar || true
          files=$(find artifacts -type f \( -name '*.zip' -o -name 'app-release.apk' -o -name 'app-release-*.apk' \) -print || true)
          if [ -z "$files" ]; then
            echo "No assets found"
            # write empty output
            echo "files=" >> $GITHUB_OUTPUT
          else
            # write newline-separated list to output
            echo "files<<EOF" >> $GITHUB_OUTPUT
            printf '%s\n' $files >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release and upload assets
        if: ${{ steps.gather.outputs.files != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: ${{ steps.gather.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
