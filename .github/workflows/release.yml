name: Release
on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runs_on: [self-hosted, Windows]
            target: windows
          - runs_on: [self-hosted, Windows]
            target: android
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (self-hosted Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $jsonUrl = 'https://storage.googleapis.com/flutter_infra_release/releases/releases_windows.json'
          $releases = Invoke-RestMethod -Uri $jsonUrl
          $baseUrl = $releases.base_url
          $stableHash = $releases.current_release.stable
          $release = $releases.releases | Where-Object { $_.hash -eq $stableHash }
          if (-not $release) { throw "Failed to resolve Flutter stable release info" }
          $archivePath = $release.archive
          $url = "$baseUrl/$archivePath"
          Write-Host "Downloading Flutter SDK: $url"
          $tempRoot = if ($env:RUNNER_TEMP) { $env:RUNNER_TEMP } elseif ($env:TEMP) { $env:TEMP } else { Join-Path $PWD 'temp' }
          if (-not (Test-Path $tempRoot)) { New-Item -ItemType Directory -Path $tempRoot | Out-Null }
          $zipPath = Join-Path $tempRoot 'flutter-sdk.zip'
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          $dest = $tempRoot
          Expand-Archive -Path $zipPath -DestinationPath $dest -Force
          $flutterBin = Join-Path $dest 'flutter/bin'
          if (-not (Test-Path $flutterBin)) { throw "Flutter bin not found at $flutterBin" }
          if ($env:GITHUB_PATH) { Add-Content -Path $env:GITHUB_PATH -Value $flutterBin } else { $env:Path = "$flutterBin;$env:Path" }
          flutter --version

      # Skip Pub cache on self-hosted Windows to avoid env path issues

      - name: flutter pub get
        run: flutter pub get

      - name: Enable Windows Desktop
        if: ${{ matrix.target == 'windows' }}
        run: flutter config --enable-windows-desktop

      - name: Build Windows
        if: ${{ matrix.target == 'windows' }}
        run: flutter build windows --release

      - name: Zip Windows artifact
        if: ${{ matrix.target == 'windows' }}
        shell: powershell
        run: |
          $out = 'build/windows/ArknightsTimer-windows.zip'
          $srcDir = 'build/windows/x64/runner/Release'
          if (Test-Path $srcDir) {
            Compress-Archive -Path (Join-Path $srcDir '*') -DestinationPath $out -Force
            Write-Host "Created $out"
          } else {
            Write-Host "Windows build output not found: $srcDir"
          }

      # Assume Android SDK/Java are pre-installed on the self-hosted Windows runner

      - name: Build Android APK
        if: ${{ matrix.target == 'android' }}
        run: flutter build apk --release

      - name: Normalize APK filename (Windows)
        if: ${{ matrix.target == 'android' }}
        shell: powershell
        run: |
          $candidates = @(
            'build/app/outputs/flutter-apk/app-release.apk',
            'build/app/outputs/apk/release/app-release.apk',
            'app-release.apk'
          )
          $found = $false
          foreach ($p in $candidates) {
            if (Test-Path $p) {
              Copy-Item $p 'app-release.apk' -Force
              Write-Host "Found APK: $p"
              $found = $true
              break
            }
          }
          if (-not $found) { Write-Host 'No APK produced' }

      - name: Upload Windows artifact
        if: ${{ matrix.target == 'windows' }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: build/windows/ArknightsTimer-windows.zip

      - name: Upload Android artifact
        if: ${{ matrix.target == 'android' }}
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-release.apk

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List assets
        id: gather
        shell: bash
        run: |
          set -e
          files=$(find artifacts -type f -maxdepth 3 -name 'ArknightsTimer-windows.zip' -o -name 'app-release.apk' || true)
          if [ -z "$files" ]; then echo "files=" >> $GITHUB_OUTPUT; else echo "files<<EOF" >> $GITHUB_OUTPUT; printf '%s\n' $files >> $GITHUB_OUTPUT; echo "EOF" >> $GITHUB_OUTPUT; fi

      - name: Create GitHub Release
        if: ${{ steps.gather.outputs.files != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: ${{ steps.gather.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}