name: Release
on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: windows
          - os: ubuntu-latest
            target: android
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Cache Pub
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: pub-cache-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('pubspec.yaml') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-

      - name: flutter pub get
        run: flutter pub get

      - name: Enable Windows Desktop
        if: ${{ matrix.target == 'windows' }}
        run: flutter config --enable-windows-desktop

      - name: Build Windows
        if: ${{ matrix.target == 'windows' }}
        run: flutter build windows --release

      - name: Zip Windows artifact
        if: ${{ matrix.target == 'windows' }}
        shell: bash
        run: |
          set -e
          cd build/windows/x64/runner/Release
          zip -r ../../../ArknightsTimer-windows.zip .
          echo "Created Windows zip"

      - name: Setup Java (Android)
        if: ${{ matrix.target == 'android' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Accept Android Licenses
        if: ${{ matrix.target == 'android' }}
        run: yes | sdkmanager --licenses || true

      - name: Build Android APK
        if: ${{ matrix.target == 'android' }}
        run: flutter build apk --release

      - name: Normalize APK filename
        if: ${{ matrix.target == 'android' }}
        shell: bash
        run: |
          set -e
          for p in \
            build/app/outputs/flutter-apk/app-release.apk \
            build/app/outputs/apk/release/app-release.apk \
            app-release.apk; do
            if [ -f "$p" ]; then cp "$p" app-release.apk; echo "Found APK at $p"; break; fi
          done
          [ -f app-release.apk ] || echo "No APK produced"

      - name: Upload Windows artifact
        if: ${{ matrix.target == 'windows' }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: build/windows/ArknightsTimer-windows.zip

      - name: Upload Android artifact
        if: ${{ matrix.target == 'android' }}
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-release.apk

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List assets
        id: gather
        shell: bash
        run: |
          set -e
          files=$(find artifacts -type f -maxdepth 3 -name 'ArknightsTimer-windows.zip' -o -name 'app-release.apk' || true)
          if [ -z "$files" ]; then echo "files=" >> $GITHUB_OUTPUT; else echo "files<<EOF" >> $GITHUB_OUTPUT; printf '%s\n' $files >> $GITHUB_OUTPUT; echo "EOF" >> $GITHUB_OUTPUT; fi

      - name: Create GitHub Release
        if: ${{ steps.gather.outputs.files != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: ${{ steps.gather.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}